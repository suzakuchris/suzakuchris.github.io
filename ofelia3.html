<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case File #8921-B: The Drowned Dame</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Special+Elite&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Cedarville+Cursive&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    
    <style>
        /* --- Background: Dark Noir Slate (Cool Tone) --- */
        body {
            background-color: #0b0c10; /* Deep blue-black */
            background-image: url("assets/unnamed.jpg"); /* Fallback if missing */
            font-family: 'Cormorant Garamond', serif;
            color: #1a1a1a;
            overflow-x: hidden;
            display: flex;
            align-items: flex-start; /* Align top for long scrolls */
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .paper-alt{
            background-image: url("assets/paper2.jpg");
        }

        /* --- Spread Layout System --- */
        .spread-container {
            display: flex;
            flex-direction: column; /* Mobile: Stacked */
            gap: 20px;
            width: 100%;
            max-width: 1400px; /* Wider for double spread */
            position: relative;
            z-index: 10;
            margin-top: 20px;
        }

        /* Desktop Double Spread */
        @media (min-width: 1024px) {
            .spread-container {
                flex-direction: row;
                align-items: flex-start;
                gap: 40px;
            }

            .left-leaf {
                width: 40%;
                position: sticky;
                top: 20px;
            }

            .right-leaf {
                width: 60%;
            }
        }

        /* --- Left Leaf (Folder Cover) --- */
        .left-leaf {
            background-color: #2d3748; /* Dark Slate Folder */
            padding: 20px;
            border-radius: 4px;
            box-shadow: 
                -10px 10px 30px rgba(0,0,0,0.5),
                inset 0 0 40px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
            position: relative;
            transform: rotate(-1deg);
        }
        
        /* Inner Folder Texture */
        .left-leaf::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 2px dashed rgba(255,255,255,0.1);
            pointer-events: none;
        }

        /* --- Right Leaf (Clipboard) --- */
        .right-leaf {
            /* This replaces the old .clipboard-board positioning context */
            position: relative;
        }

        /* --- Main Clipboard (Rusted Steel Look) --- */
        .clipboard-board {
            background-color: #1a1a1a;
            background-image: linear-gradient(to bottom right, #2d3748, #1a202c);
            box-shadow: 
                0 60px 100px -10px rgba(0,0,0,0.95),
                0 0 0 1px #4a5568;
            border-radius: 4px;
            position: relative;
            z-index: 10;
            width: 100%;
            transform: rotate(1deg); /* Slight tilt for realism */
        }

        /* --- Rusted Metal Clip --- */
        .metal-clip {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 60px;
            background: linear-gradient(180deg, #583e3e 0%, #3e2723 100%); /* Rusted hue */
            border-radius: 4px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #3e2723;
        }
        .metal-clip::before { /* Rust texture */
            content: '';
            position: absolute;
            top:0; left:0; width:100%; height:100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.3'/%3E%3C/svg%3E");
            mix-blend-mode: overlay;
        }

        /* --- Archival Paper (Cool Grey/Silver) --- */
        .parchment {
            background-color: #e2e8f0; /* Cool Grey */
            background-image: url("assets/paper.jpg");
            box-shadow: inset 0 0 60px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            padding-top: 80px;
            min-height: 900px;
            overflow: hidden; 
        }
        /* Paper texture overlay */
        .parchment::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='rough'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.05' numOctaves='2' result='noise'/%3E%3CfeDisplacementMap in='SourceGraphic' in2='noise' scale='10'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23rough)' opacity='0.1'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
            mix-blend-mode: multiply;
            z-index: 5;
        }

        /* --- Clutter Elements --- */
        
        /* Scotch Tape (Frosty) */
        .tape {
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            backdrop-filter: blur(2px); /* Frosty look */
            position: absolute;
            z-index: 20;
            opacity: 0.8;
            transform: rotate(-1deg);
        }
        .tape::after {
            content: '';
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            background: repeating-linear-gradient(90deg, rgba(255,255,255,0.2) 0, rgba(255,255,255,0.2) 1px, transparent 1px, transparent 4px);
            opacity: 0.3;
        }

        /* Scrap Notes */
        .scrap-note {
            background-color: #f7fafc; /* Very light cool grey */
            box-shadow: 1px 3px 6px rgba(0,0,0,0.2);
            padding: 15px;
            position: relative;
            transform: rotate(-1deg);
            border: 1px solid #cbd5e0;
            margin-bottom: 20px;
            z-index: 25;
        }

        /* Header Bar (Laplace Style) */
        .header-bar {
            border-top: 3px solid #2d3748;
            border-bottom: 1px solid #2d3748;
            padding: 5px 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- Lighting Overlay (Cool Moon/Lab Light) --- */
        .lighting-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(125deg, 
                rgba(0,0,0,0.85) 0%, 
                rgba(0,0,0,0.7) 5%, 
                rgba(226, 232, 240, 0.15) 30%, 
                rgba(226, 232, 240, 0.05) 80%, 
                rgba(0,0,0,0.6) 95%, 
                rgba(0,0,0,0.9) 100%
            );
            pointer-events: none;
            z-index: 50;
            mix-blend-mode: hard-light;
        }

        /* --- Tabs (Tactical) --- */
        .side-tab {
            position: absolute;
            right: -32px;
            width: 35px;
            height: 80px;
            background: #2d3748;
            border-radius: 0 4px 4px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-family: 'Special Elite', monospace;
            font-size: 10px;
            cursor: pointer;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            border: 1px solid #1a202c;
            z-index: 5;
            transition: all 0.2s;
            color: #a0aec0;
            letter-spacing: 1px;
        }
        .side-tab.active {
            background: #e2e8f0;
            color: #1a202c;
            width: 40px;
            font-weight: bold;
        }

        /* Typography */
        .font-code { font-family: 'Libre Barcode 39 Text', cursive; font-size: 24px; }
        .font-typewriter { font-family: 'Special Elite', monospace; color: #2d3748; }
        .font-serif { font-family: 'Cormorant Garamond', serif; }

        /* Animations */
        .file-content { display: none; animation: fadeIn 0.4s ease-out; }
        .file-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Grunge Stamp Effect */
        .stamp-text {
            color: #8b0000;
            font-family: 'Special Elite', cursive;
            border: 3px double #8b0000;
            display: inline-block;
            padding: 2px 8px;
            transform: rotate(-5deg);
            opacity: 0.8;
            mask-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.5'/%3E%3C/svg%3E");
        }
        
        /* Typewriter List Items */
        .typewriter-item {
            border-bottom: 1px dotted #8d6e63;
            padding: 4px 0;
            margin-bottom: 4px;
            font-family: 'Special Elite', monospace;
            font-size: 11px;
            color: #1a1a1a;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }
        .typewriter-item:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .typewriter-item:last-child { border-bottom: none; }

        /* Skill Row */
        .skill-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #cbd5e0;
            padding: 2px 0;
            font-family: 'Special Elite', monospace;
            font-size: 11px;
            color: #2d3748;
            cursor: pointer;
        }
        .skill-row:hover { background-color: rgba(0,0,0,0.05); }
        .skill-row strong { color: #1a202c; }
        .skill-highlight {
            background-color: rgba(236, 201, 75, 0.15); /* Yellow Tint */
            border-left: 2px solid #d69e2e;
            padding-left: 4px;
        }

        /* Power Checkbox */
        .power-check {
            width: 12px;
            height: 12px;
            border: 1px solid #5d4037;
            display: inline-block;
            margin-right: 8px;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .power-check:hover { background: rgba(0,0,0,0.1); }

        .power-iframe, .mitem-iframe {
            border: 4px double #4a3b32; /* Double border for old style */
            background-color: #fdfbf7; /* Paper color instead of black screen */
            width: 100%;
            height: 300px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        /* Iframe Container & Close Button Styles */
        .iframe-container {
            display: none; /* Hidden by default */
            margin-top: 2rem;
            position: relative;
            background: #ffffff;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #cbd5e0;
            transform: rotate(-0.5deg);
        }
        
        /* "Paper Tag" Close Button */
        .iframe-close-btn {
            position: absolute;
            top: -15px;
            right: 10px;
            background: #ffffff; /* Wax Seal Red */
            color: #f7fafc;
            font-family: 'Cormorant Garamond', serif;
            font-weight: bold;
            font-style: italic;
            font-size: 14px;
            padding: 4px 12px;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            transform: rotate(2deg);
        }

        .iframe-close-btn:hover {
            background: #f7fafc;
            transform: rotate(0deg) scale(1.05);
        }

        .loading-text {
            color: #4a5568;
            font-family: 'Special Elite', monospace;
            font-size: 10px;
            margin-bottom: 5px;
            border-bottom: 1px dotted #a0aec0;
            display: inline-block;
        }

        /* --- NEW STYLES FOR MEMO TAB --- */
        .detective-textarea {
            width: 100%;
            min-height: 400px;
            background-color: transparent;
            border: none;
            font-family: 'Special Elite', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #1a1a1a;
            resize: none;
            outline: none;
            background-image: repeating-linear-gradient(transparent, transparent 31px, rgba(0,0,0,0.05) 32px);
            padding: 0 10px;
        }
        
        .detective-textarea:focus {
            background-color: rgba(255,255,255,0.2);
        }

        .status-indicator {
            font-family: 'Special Elite', monospace;
            font-size: 10px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            height: 14px; /* maintain height to prevent jump */
        }
    </style>
</head>
<body onload="renderAllData()">

<!-- NEW LAYOUT STRUCTURE: Spread Container -->
<div class="spread-container">

    <!-- LEFT LEAF: The "Folder" Cover (Always visible on Desktop, Top on Mobile) -->
    <div class="left-leaf relative">
        <div class="flex flex-col gap-6">
            
            <!-- Folder Label -->
            <div class="absolute top-4 left-4 opacity-50">
                 <span class="font-typewriter text-xs text-white uppercase tracking-widest border-b border-gray-500 pb-1">Subject Profile</span>
            </div>

            <!-- MUGSHOT -->
            <div class="block w-full transform -rotate-1 mt-8">
                <div class="flex justify-center relative">
                    <div class="bg-white p-2 m-2 shadow-lg border border-gray-400 max-w-[250px]">
                        <img src="assets/Ofelia-old.png" alt="Suspect" class="w-full grayscale contrast-125 brightness-90">
                    </div>
                    <div class="tape w-24 h-8 -top-3 left-1/2 -translate-x-1/2"></div>
                    <div class="tape w-24 h-8 -bottom-3 left-1/2 -translate-x-1/2 rotate-180"></div>
                </div>
            </div>

            <!-- INFO CARD (Moved from Bio Tab) -->
            <div class="paper-alt bg-[#f7fafc] p-4 border-l-4 border-red-900 shadow-md relative transform rotate-1">
                <h2 class="font-serif text-3xl font-bold text-gray-900 mb-1">[Countess]<br/> <div class="flex">Ofelia von Moltke <img src="assets/lys.webp" style="height:20px;"/></div></h2>
                <p class="font-typewriter text-xs text-gray-500 uppercase tracking-widest mb-4">Alias: The Drowned Dame</p>
                
                <div class="grid grid-cols-2 gap-4 text-sm font-serif text-gray-800">
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Origin</span>
                        Prussia
                    </div>
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Race</span>
                        Genasi
                    </div>
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Class</span>
                        Paladin/Bard
                    </div>
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Nature</span>
                        Horror
                    </div>
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Rank</span>
                        <span id="profile-level"></span>
                    </div>
                    <div>
                        <span class="font-bold text-[10px] uppercase text-gray-500 block">Pace</span>
                        5
                    </div>
                </div>
            </div>

            <!-- STAT BLOCK (Moved from Bio Tab) -->
            <div style="background:#4e4a42;" class="w-full flex items-center bg-gray-800 text-gray-200 p-2 text-xs font-typewriter shadow-lg transform -rotate-1">
                <div class="w-full bg-[#e8e0c5] shadow-[3px_3px_5px_rgba(0,0,0,0.2)] relative p-2">
                    <div class="border-2 border-dashed border-[#5d4037] p-2 h-full">
                        <div class="text-center border-b-2 border-[#5d4037] pb-1 mb-2">
                            <span class="font-typewriter font-bold text-[#3e2723] text-xs tracking-[0.2em]">ATTRIBUTES</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Str</span><span id="val-str" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Dex</span><span id="val-dex" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Con</span><span id="val-con" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Int</span><span id="val-int" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Wis</span><span id="val-wis" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                            <div class="flex flex-col items-center"><span class="font-serif italic font-bold text-[#6d4c41] text-[10px]">Cha</span><span id="val-cha" class="font-typewriter text-xl font-bold text-[#1a1a1a] border-b border-[#a1887f] w-full text-center leading-none pb-1"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Stamp on Left Page -->
            <div class="text-center mt-4">
                 <div class="inline-block border-4 border-red-800 p-2 text-red-800 font-bold font-typewriter text-xl mask-image-grunge transform rotate-[-3deg] opacity-70 bg-white/10">
                    MONSTER: HORROR
                </div>
            </div>

        </div>
    </div>


    <!-- RIGHT LEAF: The Clipboard (Tabs & Content) -->
    <div class="right-leaf">
        <main class="clipboard-board">
            
            <!-- Rusted Metal Clip -->
            <div class="metal-clip">
                <div class="w-24 h-px bg-white opacity-20"></div>
            </div>

            <!-- TABS -->
            <div style="top: 130px;" onclick="switchTab('profile')" id="tab-profile" class="side-tab active">NOTES</div>
            <div style="top: 220px;" onclick="switchTab('vitals')" id="tab-vitals" class="side-tab">COND</div>
            <div style="top: 310px;" onclick="switchTab('feats')" id="tab-feats" class="side-tab">FEAT</div>
            <div style="top: 400px;" onclick="switchTab('features')" id="tab-features" class="side-tab">TRAIT</div>
            <div style="top: 490px;" onclick="switchTab('features2')" id="tab-features2" class="side-tab">CONT</div>
            <div style="top: 580px;" onclick="switchTab('skills')" id="tab-skills" class="side-tab">SKIL</div>
            <div style="top: 670px;" onclick="switchTab('evidence')" id="tab-evidence" class="side-tab">ITEM</div>
            <div style="top: 760px;" onclick="switchTab('memo')" id="tab-memo" class="side-tab">MEMO</div>


            <!-- MAIN PAPER -->
            <div class="parchment w-full h-full px-8 pb-12">
                
                <div class="lighting-overlay"></div>

                <!-- HEADER BAR -->
                <div class="header-bar relative z-20">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 border border-gray-600 flex items-center justify-center rounded-full">
                            <div class="w-2 h-2 bg-gray-600 rounded-full"></div>
                        </div>
                        <div>
                            <h1 class="font-serif text-2xl font-bold text-gray-800 tracking-wide uppercase">Subject Dossier</h1>
                            <p class="text-[8px] font-typewriter tracking-widest uppercase">Royal Investigation Bureau</p>
                        </div>
                    </div>
                    <div class="text-right whitespace-nowrap">
                        <p class="font-code">8921-B</p>
                        <p class="text-[9px] font-typewriter">CLR. LEVEL 5</p>
                    </div>
                </div>

                <!-- CONTENT AREA -->
                <div class="relative z-20">

                    <!-- === TAB 1: NOTES (Renamed from Bio) === -->
                    <div id="content-profile" class="file-content active">
                         <h3 class="font-typewriter text-xl mb-4 border-b border-gray-400 inline-block">Investigative Notes</h3>
                         
                         <!-- Note (Scrap) - moved back to content -->
                         <div class="scrap-note transform rotate-1 mb-8">
                            <div class="tape w-8 h-10 -right-2 top-4 rotate-90"></div>
                            <p class="font-serif italic text-lg leading-relaxed text-gray-800">
                                "She is cold to the touch. Her eyes seems dead with her hair bleached of all color. Her skin is pale, much like the winter of prussia. The air around her is always damp, even more than the thames river would. It is almost intimidating in on itself."
                            </p>
                        </div>

                        <div class="space-y-4">
                            <!-- Track 2 -->
                            <div class="bg-[#fafafa] p-3 border border-[#d7ccc8]">
                                    <div class="flex justify-between items-center mb-1">
                                    <span class="font-typewriter text-xs text-[#5d4037]">INTERROGATION_LOG.WAV</span>
                                    <span class="font-typewriter text-xs text-red-800">2:05</span>
                                </div>
                                <audio controls class="w-full h-8 opacity-70">
                                    <source src="assets/voice/vo2.m4a" type="audio/mp4">
                                </audio>
                                    <p class="font-serif italic text-sm text-gray-600 mt-2 border-l-2 border-gray-400 pl-2">
                                    "Transcript: My father often told me... A person's nobility is not determined by their worth, but by their willingness to abandon selfish desires, take on responsibility, and wear the crown of thorns when the people need them to.."
                                </p>
                            </div>

                            <!-- Track 1 -->
                            <div class="bg-[#fafafa] p-3 border border-[#d7ccc8]">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-typewriter text-xs text-[#5d4037]">RECORDING_01.WAV</span>
                                    <span class="font-typewriter text-xs text-red-800">0:14</span>
                                </div>
                                <audio controls class="w-full h-8 opacity-70">
                                    <source src="assets/voice/vo3.m4a" type="audio/mp4">
                                    Your browser does not support the audio element.
                                </audio>
                                <p class="font-serif italic text-sm text-gray-600 mt-2 border-l-2 border-gray-400 pl-2">
                                    "Transcript: People created religion for a better living, but religion lasted too long, people now lived for religion instead.."
                                </p>
                                <p class="font-serif italic text-sm text-gray-600 mt-2 border-l-2 border-gray-400 pl-2">
                                    "[CUT TRANSCRIPT]: The politics of Prussia is a matter of higher order, yet their talks of acquiring dreadnoughts of the seas ache my head so.."
                                </p>
                            </div>

                            <div class="bg-[#fafafa] p-3 border border-[#d7ccc8]">
                                    <div class="flex justify-between items-center mb-1">
                                    <span class="font-typewriter text-xs text-[#5d4037]">CONFESSION_LOG.WAV</span>
                                    <span class="font-typewriter text-xs text-red-800">15:31</span>
                                </div>
                                <audio controls class="w-full h-8 opacity-70">
                                    <source src="assets/voice/vo4.m4a" type="audio/mp4">
                                </audio>
                                <p class="font-serif italic text-sm text-gray-600 mt-2 border-l-2 border-gray-400 pl-2">
                                    "Transcript: I often dream of fire, of a blaze sweeping through.."
                                </p>
                                <p class="font-serif italic text-sm text-gray-600 mt-2 border-l-2 border-gray-400 pl-2">
                                    This is what the subject confessed every year around the time for the great of fire of london memorial.
                                </p>
                            </div>
                        </div>

                    </div>

                    <div id="content-vitals" class="file-content">
                        
                        <!-- Tactical Assessment Card -->
                        <div class="tactical-card grid-bg w-full max-w-lg mx-auto mt-4 mb-8">
                            
                            <!-- Card Header -->
                            <div class="flex justify-between items-end border-b border-gray-600 pb-2 mb-4">
                                <div>
                                    <h3 class="font-cinzel text-xl">Physician's Report</h3>
                                    <p class="text-[9px] font-typewriter text-gray-500 uppercase">Department of Biology</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-red-900 border border-red-900 px-1 text-xs font-typewriter opacity-80 rotate-[-5deg] block mt-1">STATUS: STABLE</span>
                                </div>
                            </div>

                            <!-- Grid Layout -->
                            <div class="grid grid-cols-2 gap-4">
                                
                                <!-- HP Box -->
                                <div class=" p-3 border border-gray-600 relative overflow-hidden group">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-1">Hitpoints</span>
                                    <div class="flex items-baseline gap-2">
                                        <span id="stat-hp-curr" class="font-cinzel text-3xl"></span>
                                        /
                                        <span id="stat-hp-max" class="text-gray-500 text-sm"></span>
                                    </div>
                                    <!-- HP Bar Aesthetic -->
                                    <div class="w-full h-1 bg-gray-700 mt-2">
                                        <div class="w-full h-full bg-red-900 opacity-80"></div>
                                    </div>
                                </div>

                                <!-- Surges Box -->
                                <div class=" p-3 border border-gray-600">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-1">Healing Surges (Recover: <b id="stat-hs-recover"></b>)</span>
                                    <div class="flex justify-between items-center h-full pb-2">
                                        <span class="font-cinzel text-3xl "><span id="stat-hs-curr"></span>/<span id="stat-hs-max"></span></span>
                                        <!-- Decorative notches -->
                                        <div class="flex gap-1">
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                            <div class="w-1 h-4 bg-gray-400"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Initiative -->
                                <div class=" p-3 border border-gray-600">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-1">Initiative Speed</span>
                                    <span id="stat-init" class="font-cinzel text-2xl"></span>
                                </div>

                                <!-- Passive Perception -->
                                <div class=" p-3 border border-gray-600">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-1">Passive Perception</span>
                                    <span id="stat-pperception" class="font-cinzel text-2xl"></span>
                                </div>

                                <!-- Attack Roll (Full Width) -->
                                <div class="col-span-2  p-3 border border-gray-600">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-2">Combat Reminders</span>
                                    <div id="dmg-bonuses-list" class="flex flex-col gap-1 text-xs font-typewriter text-gray-800">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>

                                <!-- Defenses (Full Width) -->
                                <div class="col-span-2  p-3 border border-gray-600">
                                    <span class="block text-[10px] font-typewriter text-gray-500 uppercase mb-2">Resilience Factors</span>
                                    <div class="grid grid-cols-4 gap-2 text-center">
                                        <div>
                                            <span class="text-gray-500 block">AC</span>
                                            <span id="stat-ac" class="font-cinzel text-xl"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 block">FORT</span>
                                            <span id="stat-fort" class="font-cinzel text-xl"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 block">REF</span>
                                            <span id="stat-ref" class="font-cinzel text-xl"></span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500 block">WILL</span>
                                            <span id="stat-will" class="font-cinzel text-xl"></span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            
                            <!-- Footer code -->
                            <div class="mt-4 pt-2 border-t border-gray-600 flex justify-between">
                                <span class="font-barcode text-xl text-gray-500">8921-B</span>
                                <span class="font-typewriter text-[8px] text-gray-600">CONFIDENTIAL</span>
                            </div>
                        </div>
                    </div>

                    <div id="content-skills" class="file-content">
                        
                        <div class="bg-white p-6 shadow-md transform rotate-1 border border-gray-300 relative max-w-lg mx-auto mt-4">
                            <div class="tape w-28 h-8 -top-4 left-1/2 -translate-x-1/2 rotate-[-1deg]"></div>
                            
                            <div class="text-center mb-6">
                                <h3 class="font-typewriter text-2xl font-bold text-gray-800 border-b-2 border-gray-800 inline-block pb-1">PROFICIENCY LEDGER</h3>
                                <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest">Operative Assessment Form 104-B</p>
                            </div>

                            <!-- Dynamic Skills Grid -->
                            <div id="skills-list" class="grid grid-cols-2 gap-x-8 gap-y-1">
                                <!-- Populated by JS -->
                            </div>

                            <div class="mt-8 flex justify-between items-end">
                                <div class="text-[10px] font-typewriter text-gray-400">
                                    EXAMINER: <span class="font-handwriting text-lg text-blue-900">Dr. Arkwright</span>
                                </div>
                                <div class="w-16 h-16 rounded-full border-4 border-blue-900 flex items-center justify-center opacity-40 transform rotate-[-12deg]">
                                    <span class="text-blue-900 font-bold text-xs text-center leading-none">CLEARED<br>FOR<br>DUTY</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shared Iframe for Skills -->
                        <div class="iframe-container" id="wrap-skills">
                            <button class="iframe-close-btn" onclick="closeAllIframes()"><img src="assets/lys.webp" style="max-width:30px;"></button>
                            <p class="loading-text">> Retrieving Record...</p>
                            <iframe id="iframe-skills" class="power-iframe" src="about:blank" frameborder="0"></iframe>
                        </div>
                    </div>

                    <!-- === TAB 4: FEATS === -->
                    <div id="content-feats" class="file-content">
                        
                        <div class="flex flex-col gap-8 mt-2">
                            <div class="w-full bg-[#fcfbf9] shadow-[0_4px_6px_rgba(0,0,0,0.1)] p-6 relative mt-4 transform rotate-[0.5deg]">
                                <div class="tape w-32 h-8 -top-4 left-1/2 -translate-x-1/2 rotate-1"></div>
                                
                                <div class="flex justify-between items-start border-b-2 border-gray-800 pb-2 mb-6">
                                    <div>
                                        <h3 class="font-typewriter font-bold text-2xl text-gray-900">STANDARD ENGAGEMENT</h3>
                                        <p class="text-[9px] font-sans text-gray-500 uppercase">File Reference: OMEGA-7</p>
                                    </div>
                                    <div class="border-2 border-red-800 px-2 py-1 transform rotate-[-5deg]">
                                        <span class="font-typewriter text-red-800 font-bold text-xs">CLASSIFIED<br>INFORMATION</span>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    
                                    <!-- AT-WILL -->
                                    <div class="col-span-1 md:col-span-2">
                                        <h4 class="font-cinzel text-lg text-gray-800 border-b border-gray-400 mb-2">Standard Engagement</h4>
                                        <div id="powers-atwill" class="grid grid-cols-2 gap-4">
                                            <!-- Populated by JS -->
                                        </div>
                                    </div>

                                    <!-- ENCOUNTER -->
                                    <div>
                                        <h4 class="font-cinzel text-lg text-gray-800 border-b border-gray-400 mb-2">Tactical Options (Enc.)</h4>
                                        <ul id="powers-encounter" class="space-y-2 font-typewriter text-sm text-gray-700">
                                            <!-- Populated by JS -->
                                        </ul>
                                    </div>

                                    <!-- DAILY -->
                                    <div>
                                        <h4 class="font-cinzel text-lg text-gray-800 border-b border-gray-400 mb-2">Restricted (Daily)</h4>
                                        <ul id="powers-daily" class="space-y-2 font-typewriter text-sm text-gray-700">
                                            <!-- Populated by JS -->
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- FEATS CARD -->
                            <div class="w-full bg-[#e8e0c5] shadow-[2px_4px_8px_rgba(0,0,0,0.3)] transform -rotate-1 relative p-2">
                                <div class="border border-[#5d4037] p-4">
                                    <div class="tape w-20 h-6 -top-5 left-10 rotate-[-2deg]"></div>
                                    <div class="border-b border-[#5d4037] mb-3 pb-1 flex justify-between items-end">
                                        <h3 class="font-typewriter font-bold text-lg text-[#3e2723] tracking-widest">OBSERVED TRAITS</h3>
                                        <span class="text-[9px] font-serif italic text-[#5d4037]">Section 3-A</span>
                                    </div>
                                    <div id="feats-list" class="space-y-1">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>

                            <!-- Shared Iframe for Feats -->
                            <div class="iframe-container" id="wrap-feats">
                                 <button class="iframe-close-btn" onclick="closeAllIframes()"><img src="assets/lys.webp" style="max-width:30px;"></button>
                                 <p class="loading-text">> Retrieving Record...</p>
                                <iframe id="iframe-feats" class="power-iframe" src="about:blank" frameborder="0"></iframe>
                            </div>
                        </div>
                    </div>

                    <!-- === TAB 5: POWERS === -->
                    <div id="content-features" class="file-content">
                        <!-- FEATURES CARD -->
                        <div class="paper-alt w-full bg-[#f2f2f2] shadow-[2px_4px_8px_rgba(0,0,0,0.2)] transform rotate-1 relative p-2 border border-gray-300">
                            <div class="tape w-20 h-6 -top-5 right-10 rotate-[3deg]"></div>
                            <div class="p-3">
                                <h3 class="font-serif font-bold text-xl text-gray-800 border-b border-gray-400 mb-3">INHERENT TRAITS</h3>
                                <div id="features-list" class="font-serif text-sm text-gray-800 space-y-4">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="content-features2" class="file-content">
                        <!-- FEATURES CARD -->
                        <div class="paper-alt w-full bg-[#f2f2f2] shadow-[2px_4px_8px_rgba(0,0,0,0.2)] transform rotate-1 relative p-2 border border-gray-300">
                            <div class="tape w-20 h-6 -top-5 right-10 rotate-[3deg]"></div>
                            <div class="p-3">
                                <h3 class="font-serif font-bold text-xl text-gray-800 border-b border-gray-400 mb-3">BACKGROUND RECORDS</h3>
                                <div id="features-list2" class="font-serif text-sm text-gray-800 space-y-4">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- === EVIDENCE (ITEMS) TAB === -->
                    <div id="content-evidence" class="file-content">
                        
                        <div class="grid grid-cols-1 gap-6">
                            <!-- Header -->
                            <div class="bg-gray-800 text-gray-200 p-2 font-typewriter text-center border border-gray-600">
                                CONFISCATED EFFECTS / GEAR
                            </div>

                            <div id="items-list" class="space-y-4">
                                 <!-- Populated by JS -->
                            </div>

                            <!-- Shared Iframe for Items -->
                            <div class="iframe-container" id="wrap-evidence">
                                 <button class="iframe-close-btn" onclick="closeAllIframes()"><img src="assets/lys.webp" style="max-width:30px;"></button>
                                 <p class="loading-text">> Retrieving Record...</p>
                                <iframe id="iframe-evidence" class="power-iframe" src="about:blank" frameborder="0"></iframe>
                            </div>
                        </div>

                    </div>

                    <!-- === NEW TAB: MEMO (FIREBASE) === -->
                    <div id="content-memo" class="file-content">
                        <div class="paper-alt w-full bg-[#fcfbf9] shadow-[2px_4px_8px_rgba(0,0,0,0.2)] relative p-6 border border-gray-300">
                            <div class="tape w-20 h-6 -top-4 right-1/2 rotate-[2deg]"></div>
                            
                            <div class="flex justify-between items-center border-b-2 border-dashed border-gray-400 pb-2 mb-4">
                                <h3 class="font-typewriter text-xl font-bold text-gray-800">INVESTIGATION LOG</h3>
                                <div id="save-status" class="status-indicator">STANDING BY...</div>
                            </div>
                            
                            <textarea id="memo-input" class="detective-textarea" placeholder="Enter case notes here..."></textarea>
                            
                            <div class="mt-4 text-center">
                                <p class="text-[9px] font-typewriter text-gray-400">CLASSIFIED DOCUMENT - DO NOT REMOVE</p>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </main>
    </div>
</div>

<script>
    // =========================================================================
    //  EDITABLE DATA: Modify these objects to update your character sheet
    // =========================================================================
    const attributes = {
        "STR": 10, "CON": 10, "DEX": 8, "INT": 18, "WIS": 10, "CHA": 20
    };

    const level = 2;
    const weaponProf = 3;
    const otherBonus = 2; //expertise and magic weapon
    const levelBonus = Math.floor(level/2);
    const HPValue = attributes['CHA'] + 13 + ((level-1)*5);
    const ACBonus = 1+2+8;//veterans armor (cloth), shield
    const REFBonus = 1+1+2; //rhythm dagger and safewing amulet
    const FORTBonus = 1+1; //safewing amulet
    const WILLBonus = 1; //safewing amulet
    const HSUsed = 0;
    const HSTotal = 8;
    const HSValue = Math.floor(HPValue/4);

    //skill versatility: untrained = +1bonus
    const skills = {
        "Acrobatics": { id: 'skill1', baseAttribute: "DEX", trained: false, otherBonus: 1-3 },
        "Arcana": { id: 'skill2', baseAttribute: "INT", trained: false, otherBonus: 1 },
        "Athletics": { id: 'skill27', baseAttribute: "STR", trained: false, otherBonus: 1-3 },
        "Bluff": { id: 'skill3', baseAttribute: "CHA", trained: true, otherBonus: 0 },
        "Diplomacy": { id: 'skill6', baseAttribute: "CHA", trained: true, otherBonus: 0 },
        "Dungeoneering": { id: 'skill7', baseAttribute: "WIS", trained: false, otherBonus: 1 },
        "Endurance": { id: 'skill8', baseAttribute: "CON", trained: false, otherBonus: 1+2-3 },
        "Heal": { id: 'skill9', baseAttribute: "WIS", trained: false, otherBonus: 1 },
        "History": { id: 'skill11', baseAttribute: "INT", trained: true, otherBonus: 0 },
        "Insight": { id: 'skill13', baseAttribute: "WIS", trained: false, otherBonus: 1 },
        "Intimidate": { id: 'skill14', baseAttribute: "CHA", trained: true, otherBonus: 0 },
        "Nature": { id: 'skill16', baseAttribute: "WIS", trained: false, otherBonus: 1+2 },
        "Perception": { id: 'skill17', baseAttribute: "WIS", trained: false, otherBonus: 1 },
        "Religion": { id: 'skill18', baseAttribute: "INT", trained: false, otherBonus: 1 },
        "Stealth": { id: 'skill20', baseAttribute: "DEX", trained: false, otherBonus: 1-3 },
        "Streetwise": { id: 'skill21', baseAttribute: "CHA", trained: true, otherBonus: 0 },
        "Thievery": { id: 'skill23', baseAttribute: "DEX", trained: false, otherBonus: 1-3 }
    };

    const powersToDisplay = [
        { id: 'power7241', name: 'Ardent Strike', type: 'At-Will' },
        { id: 'power14449', name: 'Song of Serendipity', type: 'At-Will' },

        { id: 'power15849', name: 'Skald\'s Aura', type: 'Encounter' },
        { id: 'power13815', name: 'Dread Smite', type: 'Encounter' },
        { id: 'power1770', name: 'Swiftcurrent', type: 'Encounter' },
        { id: 'power3286', name: 'Divine Counter', type: 'Encounter' },

        // { id: 'custom_power/grimoire', name: 'Grimoire\'s Shield', type: 'Daily' },
        { id: 'power14456', name: 'Disruptive Words', type: 'Daily' },
    ];

    const featsToDisplay = [
        { id: 'feat3741', name: 'Devout Protector Expertise' },
        { id: 'feat1366', name: 'Hybrid Talent (Paladin Armor Proficiency)' },
        { id: 'feat3668', name: 'Skald\'s Training' },
    ];

    const magicItems = [
        { id: 'armor2986', name: 'Veterans Armor (+1)' },
        { id: 'item498', name: 'Amulet of Protection (+1)' },
        { id: 'weapon1782', name: 'Magic Weapon (+1)' },
    ];

    const bonusDamageReminder = [
        { plus: `${(levelBonus+weaponProf+otherBonus+getMod(attributes["CHA"]))}`, notes: 'Melee Basic Attack (Ardent Strike)' },
        { plus: `${getMod(attributes["CHA"])+2}`, notes: 'Bonus damage if attacking with CA using paladin powers'},
        { plus: `${getMod(attributes["CHA"])+2}`, notes: 'Bonus damage through dread smite'},
    ];

    const miscFeaturesToDisplay = [
        { name: 'Genasi Traits', content: `
            Size: Medium
            Speed: 6 squares.
            Vision: Normal

            Languages: Common, Primordial
            Skill Bonuses: +2 Endurance, +2 Nature.
            Elemental Manifestation: Watersoul: You can breathe underwater. You also gain a +2 racial bonus to saving throws against ongoing damage and the swiftcurrent power.
            Elemental Origins: Your ancestors were native to the Elemental Chaos, so you are considered an elemental creature for the purpose of effects that relate to creature origin.
        ` },
        { name: 'Blackguard Paladin (Bard/Paladin)', content: `
            Armor Proficiencies:Cloth, leather, hide, chainmail, scale, plate; heavy shields, light shields.
            Weapon Proficiencies:Simple melee, military melee, simple ranged, military ranged.
            Implement:Holy symbols, wands
            Bonus to Defense:+2 Ref

            Hit Points at 1st Level: 7.5 + 6 + Constitution Score.
            Hit Points per Level Gained: 3 + 2.5
            Healing Surges per Day: 5 + 3.5

            SKILL VERSATILITY
            You gain a +1 bonus to untrained skill checks.

            BARD HYBRID
            Extra 1 skill trained.

            DARK MENACE (HYBRID)
            Whenever you make a weapon attack against an enemy granting combat advantage to you using a paladin power or paladin paragon path power, that enemy takes extra damage equal to your Charisma modifier.

            DREAD SMITE (HYBRID)
            You can select the dread smite power whenever you have the opportunity to gain or replace a class encounter attack power that has a level. If you already have dread smite, you gain an additional use of the power if you select it again.

            SPIRIT OF VICE (HYBRID)
            You choose a vice and gain the benefit of the Spirit of Vice class feature, except that the benefit applies only to your paladin powers and paladin paragon path powers.
            
            Spirit of Vice (Fury)
            While you have combat advantage against an enemy, you gain a +2 bonus to damage rolls. The bonus increases to +4 while you are bloodied or adjacent to a bloodied creature.
        ` },
    ];

    const miscFeaturesToDisplay2 = [
        { name: 'Patrician', content: `
            Patricians: The nobility, wealthy, or influential, who never need to worry about money and some laws. You gain training in Intimidate.
        ` },
        { name: 'Horror', content: `
            Horror: Resist 2 Ranged, Vulnerable 2 Area and Close. You end Dazed and Stunned condition at the end of your turn. You gain Blindsight 5sq.
        ` },
        { name: 'Potency', content: `
            Theme: Potency (Tag)
            Pick a certain range (Melee, Ranged, or Area/Close) or damage type (Fire, Cold, Psychic, Acid, Radiant, Necrotic, Untyped, etc.) You are more Potent with this Tag, and powers with the tag gains benefits according to your level (starting with +1, and increased to +2 at level 5).
            Further, one of your 1st level melee or ranged unaugmented At Will Attack power with Potency that rolls damage is considered Basic Attack.
            You also gain [Inventory] to store your items at a dimensional storage. Drawing items from [Inventory] is part of the action to use them.
            Choices: Melee, Ardent Strike as MBA.

            Level 1 Benefit
            You gain a bonus feat. You also gain a +1 bonus to attack rolls, damage, bonuses, and penalties on powers with the Potency. Further, once per encounter, you can reroll failed attack roll using power with the Potency.
            Choices: Skald Training

            Level 5 Benefit
            You gain a bonus feat. You also increase the bonus to your Potency by 1. Choose 2 skills, and you gain +2 bonus to their rolls, and once per encounter you can reroll those skill check when you dislike the result.
            Choices: -

            Level 10 Benefit 
            You gain a bonus feat. Also, choose a Standard action Daily Power with the Potency. You can use them as a Minor action.
            Choices: -
        ` },
    ]; 

    // =========================================================================
    //  LOGIC & RENDERING
    // =========================================================================

    // Helper: Calculate Modifier (Score - 10) / 2
    function getMod(score) {
        return Math.floor((score - 10) / 2);
    }

    // Helper: Update Iframe
    function showCompendium(id) {
        if (!id) return;
        const url = `https://iws.mx/dnd/?view=${id}`;
        
        // Update iframes
        document.querySelectorAll('.power-iframe').forEach(iframe => {
            iframe.src = url;
        });

        // Show the containers
        document.querySelectorAll('.iframe-container').forEach(container => {
             // Only show the container if it is within the active tab
             // Find the parent content div
             const parentContent = container.closest('.file-content');
             if(parentContent && parentContent.classList.contains('active')){
                 container.style.display = 'block';
             }
        });
    }

    // Helper: Close all iframes
    function closeAllIframes() {
        document.querySelectorAll('.iframe-container').forEach(container => {
            container.style.display = 'none';
        });
        document.querySelectorAll('.power-iframe').forEach(iframe => {
            iframe.src = 'about:blank';
        });
    }

    function renderAllData() {
        // --- 1. Bio / Attributes ---
        document.getElementById('val-str').innerText = attributes.STR;
        document.getElementById('val-dex').innerText = attributes.DEX;
        document.getElementById('val-con').innerText = attributes.CON;
        document.getElementById('val-int').innerText = attributes.INT;
        document.getElementById('val-wis').innerText = attributes.WIS;
        document.getElementById('val-cha').innerText = attributes.CHA;
        document.getElementById('profile-level').innerText = level;

        // --- 2. Vitals & Defenses ---
        const strMod = getMod(attributes.STR);
        const conMod = getMod(attributes.CON);
        const dexMod = getMod(attributes.DEX);
        const intMod = getMod(attributes.INT);
        const wisMod = getMod(attributes.WIS);
        const chaMod = getMod(attributes.CHA);

        // Initiative: Dex Mod + Level Bonus
        const init = intMod + levelBonus + 1; 
        document.getElementById('stat-init').innerText = (init >= 0 ? "+" : "") + init;

        // Passive Perception: 10 + Skill Total
        const perceptionSkill = skills["Perception"];
        const pPerception = 10 + levelBonus + getMod(attributes[perceptionSkill.baseAttribute]) + (perceptionSkill.trained ? 5 : 0) + perceptionSkill.otherBonus;
        document.getElementById('stat-pperception').innerText = pPerception;

        // Defenses: 10 + Half Level + Ability Mod + Class/Feat Bonuses
        // AC: Uses Dex or Int (or Str due to Dragon Sorcerer feat/feature if applicable, but standard is Dex/Int. 
        // Note: The prompt implies Sorcerer might use Str for AC via Draconic Resilience).
        // Draconic Resilience: "use Strength modifier in place of Dex/Int".
        const acBaseMod = 0
        const ac = 10 + levelBonus + acBaseMod + ACBonus;

        const fortBaseMod = Math.max(strMod, conMod);
        const fort = 10 + levelBonus + fortBaseMod + FORTBonus;

        const refBaseMod = Math.max(dexMod, intMod);
        const ref = 10 + levelBonus + refBaseMod + REFBonus;

        const willBaseMod = Math.max(wisMod, chaMod);
        const will = 10 + levelBonus + willBaseMod + WILLBonus;

        document.getElementById('stat-ac').innerText = ac;
        document.getElementById('stat-fort').innerText = fort;
        document.getElementById('stat-ref').innerText = ref;
        document.getElementById('stat-will').innerText = will;

        document.getElementById('stat-hp-curr').innerText = HPValue;
        document.getElementById('stat-hp-max').innerText = HPValue;

        document.getElementById('stat-hs-curr').innerText = HSTotal;
        document.getElementById('stat-hs-max').innerText = HSTotal;
        document.getElementById('stat-hs-recover').innerText = HSValue;

        // Damage Bonus List
        const bonusListEl = document.getElementById('dmg-bonuses-list');
        bonusListEl.innerHTML = '';
        bonusDamageReminder.forEach(b => {
            const row = document.createElement('div');
            row.innerHTML = `<span class="font-bold">+${b.plus}</span> <span>${b.notes}</span>`;
            bonusListEl.appendChild(row);
        });

        // --- 3. Skills ---
        const skillsContainer = document.getElementById('skills-list');
        skillsContainer.innerHTML = '';
        
        for (const [name, data] of Object.entries(skills)) {
            const attrMod = getMod(attributes[data.baseAttribute]);
            const trainedBonus = data.trained ? 5 : 0;
            const total = levelBonus + attrMod + trainedBonus + data.otherBonus;
            
            const row = document.createElement('div');
            // Highlight trained skills
            row.className = `skill-row ${data.trained ? 'skill-highlight' : ''}`;
            
            // On Click
            if (data.id) {
                row.onclick = () => showCompendium(data.id);
            }

            row.innerHTML = `
                <span>${name} <span class="text-[9px] text-gray-400">(${data.baseAttribute})</span></span>
                <strong>${total >= 0 ? '+' : ''}${total}</strong>
            `;
            skillsContainer.appendChild(row);
        }

        // --- 4. Powers ---
        const atWillContainer = document.getElementById('powers-atwill');
        const encounterContainer = document.getElementById('powers-encounter');
        const dailyContainer = document.getElementById('powers-daily');

        atWillContainer.innerHTML = '';
        encounterContainer.innerHTML = '';
        dailyContainer.innerHTML = '';

        powersToDisplay.forEach(p => {
            if (p.type === 'At-Will') {
                const el = document.createElement('div');
                el.className = "bg-gray-100 p-2 border-l-4 border-green-700 cursor-pointer hover:bg-gray-200 transition";
                el.innerHTML = `<span class="font-serif font-bold text-sm">${p.name}</span>`;
                if(p.id) el.onclick = () => showCompendium(p.id);
                atWillContainer.appendChild(el);
            } else if (p.type === 'Encounter') {
                const el = document.createElement('li');
                el.className = "flex items-center cursor-pointer hover:text-red-800";
                el.innerHTML = `<div class="power-check"></div> ${p.name}`;
                if(p.id) el.onclick = () => showCompendium(p.id);
                encounterContainer.appendChild(el);
            } else if (p.type === 'Daily') {
                const el = document.createElement('li');
                el.className = "flex items-center cursor-pointer hover:text-red-800";
                el.innerHTML = `<div class="power-check"></div> ${p.name}`;
                if(p.id) el.onclick = () => showCompendium(p.id);
                dailyContainer.appendChild(el);
            }
        });

        // --- 5. Feats ---
        const featsContainer = document.getElementById('feats-list');
        featsContainer.innerHTML = '';
        featsToDisplay.forEach(f => {
            const el = document.createElement('div');
            el.className = "typewriter-item";
            el.innerHTML = `<span>${f.name}</span> <span class="text-[9px]">[FEAT]</span>`;
            if(f.id) el.onclick = () => showCompendium(f.id);
            featsContainer.appendChild(el);
        });

        // --- 6. Features (Misc) ---
        const featuresContainer = document.getElementById('features-list');
        featuresContainer.innerHTML = '';
        miscFeaturesToDisplay.forEach(f => {
             const el = document.createElement('div');
             // Format content with line breaks
             const contentHtml = f.content.replace(/\n/g, '<br>');
             el.innerHTML = `
                <strong class="block text-gray-900 border-b border-gray-400 mb-1">${f.name}</strong>
                <p class="text-xs leading-relaxed pl-2 border-l-2 border-gray-300">${contentHtml}</p>
             `;
             featuresContainer.appendChild(el);
        });

        //6.5 features 2
        const featuresContainer2 = document.getElementById('features-list2');
        featuresContainer2.innerHTML = '';
        miscFeaturesToDisplay2.forEach(f => {
             const el = document.createElement('div');
             // Format content with line breaks
             const contentHtml = f.content.replace(/\n/g, '<br>');
             el.innerHTML = `
                <strong class="block text-gray-900 border-b border-gray-400 mb-1">${f.name}</strong>
                <p class="text-xs leading-relaxed pl-2 border-l-2 border-gray-300">${contentHtml}</p>
             `;
             featuresContainer2.appendChild(el);
        });

        // --- 7. Items ---
        const itemsContainer = document.getElementById('items-list');
        itemsContainer.innerHTML = '';
        magicItems.forEach(item => {
            const el = document.createElement('div');
            el.className = "relative bg-transparent border-b border-dashed border-gray-400 p-2 cursor-pointer hover:bg-black/5";
            el.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-serif font-bold text-gray-800">${item.name}</span>
                    <span class="font-typewriter text-[9px] text-gray-500">${item.id || 'N/A'}</span>
                </div>
            `;
            if(item.id) el.onclick = () => showCompendium(item.id);
            itemsContainer.appendChild(el);
        });
    }

    // === TAB LOGIC ===
    function switchTab(tabId) {
        // 1. Close all open iframes/compendiums to clean the desk
        closeAllIframes();

        // 2. Switch visual tab styling
        document.querySelectorAll('.side-tab').forEach(tab => {
            tab.classList.remove('active');
            tab.style.backgroundColor = '#2d3748';
            tab.style.color = '#a0aec0';
        });
        const activeTab = document.getElementById(`tab-${tabId}`);
        activeTab.classList.add('active');
        activeTab.style.backgroundColor = '#e2e8f0';
        activeTab.style.color = '#1a202c';

        // 3. Switch Content
        document.querySelectorAll('.file-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`content-${tabId}`).classList.add('active');
    }
</script>

<!-- FIREBASE COMPAT SCRIPT (Adapted from Anneliese Code) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // =========================================================================
    //  FIREBASE CONFIGURATION
    //  (Paste your keys from the Firebase Console here)
    // =========================================================================
    const firebaseConfig = {
        // Replace with the config from your Firebase project.
        apiKey: "AIzaSyAZmkytKusbdoDt0g6GOWNYlsXh5TkQI8M",
        authDomain: "rise-character-sheet.firebaseapp.com",
        projectId: "rise-character-sheet",
        storageBucket: "rise-character-sheet.firebasestorage.app",
        messagingSenderId: "633547066454",
        appId: "1:633547066454:web:63dfbb6a724308b1fbbff7",
        measurementId: "G-M80TGFZC8P"
    };

    // Initialize Firebase (Simple, no Auth)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Document Reference: simpler path like your Anneliese code
    const docRef = db.collection("ofelia_archives").doc("case_file_8921b"); 

    const memoInput = document.getElementById('memo-input');
    const statusDiv = document.getElementById('save-status');
    let debounceTimer;

    // 1. LOAD DATA (One-time fetch, avoiding 'onSnapshot' issues)
    docRef.get().then((doc) => {
        if (doc.exists) {
            memoInput.value = doc.data().notes || "";
            statusDiv.innerText = "ARCHIVE RETRIEVED";
            statusDiv.style.color = "#2f855a"; // Dark Green
        } else {
            statusDiv.innerText = "NEW FILE STARTED";
        }
    }).catch((error) => {
        console.error("Error loading data:", error);
        statusDiv.innerText = "CONNECTION FAILED";
        statusDiv.style.color = "red";
    });

    // 2. SAVE DATA (Debounced Input)
    memoInput.addEventListener('input', () => {
        statusDiv.innerText = "RECORDING EVIDENCE...";
        statusDiv.style.color = "#718096"; // Gray

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const dataToSave = {
                notes: memoInput.value,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            docRef.set(dataToSave, { merge: true })
            .then(() => {
                statusDiv.innerText = "LOG UPDATED";
                statusDiv.style.color = "#2f855a"; // Dark Green
            })
            .catch((error) => {
                console.error("Error saving data:", error);
                statusDiv.innerText = "SAVE FAILED";
                statusDiv.style.color = "red";
            });
        }, 1000); // 1 second delay
    });
</script>

</body>
</html>