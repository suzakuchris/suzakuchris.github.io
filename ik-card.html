<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Stat Card Maker</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <style>
            body{
                background: white;
            }
            .stat-card{
                background-color:rgb(41,37,26);
            }

            .stat-name, .stat-size{
                text-transform: uppercase;
            }

            .stat-photo{
                height:100%;
                width:100%;
                position:relative;
            }

            .stat-lore{
                white-space: pre-wrap;
            }

            .stat-property .property-name{
                font-weight:600;
            }

            .stat-focus, .stat-init{
                width:100px;
                height:100px;
                /* border-radius:50%; */
            }

            .faction-logo{
                top: -55%;
                left: -10%;
                position:absolute;
                width:100%;
            }

            .vitality-bars{
                border:5px solid #8b8b8b;
            }

            .attack .icon{
                background-repeat: no-repeat;
                background-size: contain;
                background-position: center;
                height:100%;
            }

            .attack .icon.melee{
                background-image:url("https://media.discordapp.net/attachments/901047542287056936/1188365894850728057/image.png?ex=659a42fc&is=6587cdfc&hm=836cc3ab2acbd80969eadb11f9e01b0c913ba1c289b5aa1f49e07f581202ffcf&=&format=webp&quality=lossless");
            }

            .attack .icon.ranged{
                background-image:url("https://media.discordapp.net/attachments/901047542287056936/1188365894448066590/image.png?ex=659a42fc&is=6587cdfc&hm=09f69cc4ce27b18fa15107793cd03fc7f8772af3200bf024afde5e7216b63269&=&format=webp&quality=lossless");
            }
            .parchment{
                /* border-radius: 15% 15% 0% 0%; */
                margin: 2em 0;
                padding: 1em;
                box-shadow: 2px 3px 20px black, 0 0 60px #8a4d0f inset;
                background: #fffef0;
                filter: url(#wavy2);
            }

            .button-controls{
                position:fixed;
                bottom:0;
                right:0;
                opacity:0;
                transition:0.2s;
                z-index:5;
            }
            .button-controls:hover{
                opacity: 1;
            }
        </style>
        <style>
            /* Fonts! */
            @font-face {
                font-family:"Cryxian";
                src: url("templar-heavy.ttf") format("truetype");
            }
            .cryx .font{
                font-family: "Cryxian";
            }
        </style>
        <style>
            /* Border! */
            .ik-border {
                box-sizing: border-box; 
                height:100%;
                width:100%;
                position:absolute;
                z-index:3;
                border-style:solid;
                pointer-events: none; 
            }
            .unit-faction .ik-border{
                border:10px solid #9b9153;
                
            }

            .unit-faction.cryx .ik-border{
                border-width: 60px 28px 87px 24px;
                -moz-border-image: url(http://i.imgur.com/qfJxhX2.png) 60 28 87 24 repeat;
                -webkit-border-image: url(http://i.imgur.com/qfJxhX2.png) 60 28 87 24 repeat;
                -o-border-image: url(http://i.imgur.com/qfJxhX2.png) 60 28 87 24 repeat;
                border-image: url(http://i.imgur.com/qfJxhX2.png) 60 28 87 24 repeat;
            }
            .card{
                z-index:1;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="ik">
                <div class="card unit-faction">
                    <div class="ik-border"></div>
                    <div class="card-body stat-card px-4">
                        <div class="row parchment font position-relative" style="z-index:5;">
                            <div class="col-2 position-relative">
                                <img class="faction-logo" src="" class="w-100">
                            </div>
                            <div class="col">
                                <div class="mt-2">
                                    <h3 class="stat-name"></h3>
                                </div>
                                <div class="text-muted">
                                    <h4 class="stat-title"></h4>
                                </div>
                            </div>
                            <div class="col-2 d-flex align-items-center justify-content-end">
                                <div><span class="stat-size"></span> BASE</div>
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-6">
                                <div class="stat-photo">
                                    <div class="position-relative">
                                        <img src="" class="w-100" style="min-height:300px;">
                                        <div class="position-absolute w-100 my-0 bottom-0 d-flex justify-content-center pb-3">
                                            <div class="parchment my-0 mx-3 stat-focus text-center">
                                                <div class="fw-bold">FO/ARC</div>
                                                <div class="focus">
                                                    <h2></h2>
                                                </div>
                                            </div>

                                            <div class="parchment my-0 mx-3 stat-init text-center">
                                                <div class="fw-bold">INIT</div>
                                                <div class="init">
                                                    <h2></h2>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="row vitality-bars pt-1 ps-1 mx-0 d-flex justify-content-end">
                                    <div class="col-1 bg-warning">&nbsp;</div>
                                </div>
                                <div class="row parchment main-stats mt-2">
                                    <div class="col-12">
                                        <table class="table text-center mb-0">
                                            <thead>
                                                <tr class="text-white bg-black">
                                                    <th>SPD</th>
                                                    <th>STR</th>
                                                    <th>MAT</th>
                                                    <th>RAT</th>
                                                    <th>DEF</th>
                                                    <th>ARM</th>
                                                    <th>CMD</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td class="spd">8</td>
                                                    <td class="str">8</td>
                                                    <td class="mat">8</td>
                                                    <td class="rat">8</td>
                                                    <td class="def">8</td>
                                                    <td class="arm">8</td>
                                                    <td class="cmd bg-secondary bg-gradient text-white">8</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="attacks">
                                    
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-3 parchment my-0 stat-property">
                                
                            </div>
                            <!-- <div class="col-auto"></div> -->
                            <div class="col parchment my-0">
                                <div class="stat-lore"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8 parchment">
                                <table class="table stat-spells text-center table-striped">
                                    <thead>
                                        <tr class="bg-black text-white">
                                            <th class="text-start">SPELLS</th>
                                            <th>COST</th>
                                            <th>RNG</th>
                                            <th>AOE</th>
                                            <th>POW</th>
                                            <th>UP</th>
                                            <th>OFF</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                       
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-4 parchment stat-features">
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="btn-group button-controls">
            <button class="btn btn-primary edit-button" data-bs-toggle="modal" data-bs-target="#modal_edit"><i class="fa-solid fa-pencil pe-2"></i>Edit</button>
            <button class="btn btn-primary save-button" data-bs-toggle="modal" data-bs-target="#modal_save" onclick="save_data()"><i class="fa-solid fa-save pe-2"></i>Save</button>
            <button class="btn btn-primary load-button" data-bs-toggle="modal" data-bs-target="#modal_load"><i class="fa-solid fa-upload pe-2"></i>Load</button>
            <button class="btn btn-primary del-button" onclick="delete_data()"><i class="fa-solid fa-times pe-2"></i>Delete</button>
        </div>

        <div id="modal_edit" class="modal fade" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Adjust Card</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="event.preventDefault();reconcile_data(this);">
                            <fieldset class="border p-2 row mx-0">
                                <legend>Basic Stats</legend>
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label>Faction</label>
                                        <select class="form-control" name="unit_faction"></select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group mb-2">
                                        <label>Name</label>
                                        <input class="form-control" type="text" name="stat_name">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group mb-2">
                                        <label>Title</label>
                                        <input class="form-control" type="text" name="stat_title">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group mb-2">
                                        <label>Size</label>
                                        <select class="form-control" name="stat_size"></select>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group mb-2">
                                        <label>Vitality</label>
                                        <input class="form-control" type="number" min="0" name="stat_vitality">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label>Photo URL</label>
                                        <input class="form-control" type="text" name="stat_photo">
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-group mb-2">
                                        <label>Lore and tidbits</label>
                                        <textarea name="stat_lore" rows="5" class="form-control"></textarea>
                                    </div>
                                </div>
                            </fieldset>
                            <fieldset class="border p-2 mt-3 row mx-0">
                                <legend>Main Stats</legend>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>SPD</label>
                                        <input class="form-control" type="number" min="0" name="stat_spd">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>STR</label>
                                        <input class="form-control" type="number" min="0" name="stat_str">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>MAT</label>
                                        <input class="form-control" type="number" min="0" name="stat_mat">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>RAT</label>
                                        <input class="form-control" type="number" min="0" name="stat_rat">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>DEF</label>
                                        <input class="form-control" type="number" min="0" name="stat_def">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>ARM</label>
                                        <input class="form-control" type="number" min="0" name="stat_arm">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>CMD</label>
                                        <input class="form-control" type="number" min="0" name="stat_cmd">
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="form-group mb-2">
                                        <label>FOCUS</label>
                                        <input class="form-control" type="number" min="0" name="stat_focus">
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="border p-2 mt-3 row mx-0">
                                <legend class="col">Attacks</legend>
                                <div class="col-auto d-flex justify-content-end align-items-center">
                                    <div class="button-group">
                                        <button type="button" class="btn btn-sm btn-light text-danger border-danger" onclick="add_attack('melee')"><i class="fa-solid fa-plus pe-2"></i>Melee Attack</button>
                                        <button type="button" class="btn btn-sm btn-light text-success border-success" onclick="add_attack('range')"><i class="fa-solid fa-plus pe-2"></i>Ranged Attack</button>
                                    </div>
                                </div>
                                <div class="attack_lists col-12"></div>
                            </fieldset>

                            <fieldset class="border p-2 mt-3 row mx-0">
                                <legend class="col">Properties</legend>
                                <div class="col-auto d-flex justify-content-end align-items-center">
                                    <div class="button-group">
                                        <button type="button" class="btn btn-sm btn-light text-secondary border-secondary" onclick="add_property()"><i class="fa-solid fa-plus pe-2"></i>Property</button>
                                    </div>
                                </div>
                                <div class="property_lists col-12"></div>
                            </fieldset>

                            <fieldset class="border p-2 mt-3 row mx-0">
                                <legend class="col">Spells</legend>
                                <div class="col-auto d-flex justify-content-end align-items-center">
                                    <div class="button-group">
                                        <button type="button" class="btn btn-sm btn-light text-secondary border-secondary" onclick="add_spell()"><i class="fa-solid fa-plus pe-2"></i>Spell</button>
                                    </div>
                                </div>
                                <div class="spell_lists col-12"></div>
                            </fieldset>

                            <fieldset class="border p-2 mt-3 row mx-0">
                                <legend class="col">Features</legend>
                                <div class="col-auto d-flex justify-content-end align-items-center">
                                    <div class="button-group">
                                        <button type="button" class="btn btn-sm btn-light text-secondary border-secondary" onclick="add_feature()"><i class="fa-solid fa-plus pe-2"></i>Feature</button>
                                    </div>
                                </div>
                                <div class="feature_lists col-12"></div>
                            </fieldset>
                            <button type="submit" id="btnSubmit" class="d-none"></button>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <label for="btnSubmit" class="btn btn-primary">Save changes</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal_save" class="modal fade" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Copy this somewhere!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" id="save_output" rows="10"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div id="modal_load" class="modal fade" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Paste your save below</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" id="load_data" rows="10"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button onclick="load_data()" class="btn btn-primary">Load Data</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
        <script>
            //immutable data
            var faction_lists = [
                {
                    "value":"",
                    "text":"--Select Faction--",
                    "logo":""
                },
                {
                    "value":"cryx",
                    "text":"Cryx",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/Cryx.png"
                },
                {
                    "value":"cygnar",
                    "text":"Cygnar",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/warcasters.png"
                },
                {
                    "value":"khador",
                    "text":"Khador",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/Khador.png"
                },
                {
                    "value":"menoth",
                    "text":"Menoth",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/Protectorate.png"
                },
                {
                    "value":"llael",
                    "text":"Llael",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/Mercenaries.png"
                },
                {
                    "value":"mercenary",
                    "text":"Mercenary",
                    "logo":"http://cards.privateerpress.com/wp-content/uploads/Mercenaries.png"
                },
                {
                    "value":"ord",
                    "text":"Ordic",
                    "logo":"https://media.discordapp.net/attachments/1147457291612860448/1180395017693564928/ordic2.png?ex=6598f306&is=65867e06&hm=42d6dad769da8f515ea2f5a664d492526c1ab8a4194cd20b62cbb2fc617ac749&=&format=webp&quality=lossless&width=478&height=670"
                },
            ];

            var size_lists = [
                {
                    "value":"small",
                    "text":"Small"
                },
                {
                    "value":"medium",
                    "text":"Medium"
                },
                {
                    "value":"large",
                    "text":"Large"
                },
            ]

        </script>
        <script>
            var basic_stats = {
                "unit_faction":"",
                "stat_name":"", 
                "stat_title":"",
                "stat_size":"",
                "stat_photo":"",
                "stat_lore": ""
            };

            var unit_stats = {
                "spd_stat":8,
                "str_stat":8,
                "mat_stat":8,
                "rat_stat":8,
                "def_stat":8,
                "arm_stat":8,
                "cmd_stat":8,
                "vit_stat":8,
                "focus_stat":0,
                "vitality_stat":0
            };

            var unit_attacks = [];
            var unit_properties = [];
            var unit_spells = [];
            var unit_features = [];
        </script>
        
        <script>
            //modal stuffs!
            function make_select(list, object, prefill = ''){
                var select = object;
                var opt = '';
                $.each(list, function(x,y){
                    var status_selected = '';
                    if(y.value == prefill){
                        status_selected = 'selected';
                    }
                    opt += `
                        <option value="`+y.value+`" `+status_selected+`>`+y.text+`</option>
                    `;
                });
                select.html(opt);
            }

            function prefill_modal(){
                make_select(faction_lists, $("[name='unit_faction']"), basic_stats.unit_faction);
                make_select(size_lists, $("[name='stat_size']"), basic_stats.stat_size);

                prefill_basic_stats();
                prefill_main_stats();
                prefill_attacks();
                prefill_properties();
                prefill_spells();
                prefill_features();
            }

            //basic and stuffs
            function prefill_basic_stats(){
                var name_input = $("[name='stat_name']");
                name_input.val(basic_stats.stat_name);

                var title_input = $("[name='stat_title']");
                title_input.val(basic_stats.stat_title);

                var photo_input = $("[name='stat_photo']");
                photo_input.val(basic_stats.stat_photo);

                var lore_input = $("[name='stat_lore']");
                lore_input.val(basic_stats.stat_lore);
            }

            function prefill_main_stats(){
                var input = $("[name='stat_spd']");
                input.val(unit_stats.spd_stat);

                var input = $("[name='stat_str']");
                input.val(unit_stats.str_stat);

                var input = $("[name='stat_mat']");
                input.val(unit_stats.mat_stat);

                var input = $("[name='stat_rat']");
                input.val(unit_stats.rat_stat);

                var input = $("[name='stat_def']");
                input.val(unit_stats.def_stat);

                var input = $("[name='stat_arm']");
                input.val(unit_stats.arm_stat);

                var input = $("[name='stat_cmd']");
                input.val(unit_stats.cmd_stat);

                var input = $("[name='stat_focus']");
                input.val(unit_stats.focus_stat);

                var input = $("[name='stat_vitality']");
                input.val(unit_stats.vitality_stat);
            }

            //attacks
            function remove_attack(btn){
                var row_attack = $(btn).closest('.attack');
                row_attack.remove();
            }

            function prefill_attacks(){
                var container = $('.attack_lists');
                container.html('');

                $.each(unit_attacks, function(x,y){
                    if(y.attack_type == "melee"){
                        var html = create_melee_attack();
                        var obj = $(html);
                        obj.find(".attack_name_input").val(y.attack_name);
                        obj.find(".attack_range_input").val(y.attack_rng);
                        obj.find(".attack_pow_input").val(y.attack_pow);
                        obj.find(".attack_damage_input").val(y.attack_damage);
                        obj.find(".attack_desc_input").val(y.attack_desc);
                    }else{
                        var html = create_range_attack();
                        var obj = $(html);
                        obj.find(".attack_name_input").val(y.attack_name);
                        obj.find(".attack_range_input").val(y.attack_rng);
                        obj.find(".attack_rof_input").val(y.attack_rof);
                        obj.find(".attack_aoe_input").val(y.attack_aoe);
                        obj.find(".attack_pow_input").val(y.attack_pow);
                        obj.find(".attack_desc_input").val(y.attack_desc);
                    }
                    container.append(obj);
                });
            }

            function add_attack(type){
                if(type == "melee"){
                    var html = create_melee_attack();
                }else{
                    var html = create_range_attack();
                }

                var container = $('.attack_lists');
                container.append(html);
            }

            function create_melee_attack(){
                var index = 0;
                var attacks = $(".attack_lists .attack");
                $.each(attacks, function(x,y){
                    var att = $(y).data('attack');
                    index = att+1;
                });
                var html = `
                    <div class="row attack attack-melee my-2 border-danger p-4 border" data-attack="`+index+`">
                        <input type="hidden" name="attacks[`+index+`][attack_type]" value="melee">
                        <div class="col-12 position-relative">
                            <b>Melee Attack</b>
                            <button type="button" class="position-absolute btn btn-sm btn-light text-danger" style="top:0;right:0;" onclick="remove_attack(this);"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Attack Name</label>
                                <input class="attack_name_input form-control" type="text" name="attacks[`+index+`][attack_name]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Attack Range</label>
                                <input class="attack_range_input form-control" type="text" name="attacks[`+index+`][attack_rng]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Attack POW</label>
                                <input class="attack_pow_input form-control" type="text" name="attacks[`+index+`][attack_pow]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Attack P+S</label>
                                <input class="attack_damage_input form-control" type="text" name="attacks[`+index+`][attack_damage]">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Attack Description</label>
                                <textarea class="attack_desc_input form-control" rows="4" name="attacks[`+index+`][attack_desc]"></textarea>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }

            function create_range_attack(){
                var index = 0;
                var attacks = $(".attack_lists .attack");
                $.each(attacks, function(x,y){
                    var att = $(y).data('attack');
                    index = att+1;
                });
                var html = `
                    <div class="row attack attack-range my-2 border-success p-4 border" data-attack="`+index+`">
                        <input type="hidden" name="attacks[`+index+`][attack_type]" value="ranged">
                        <div class="col-12 position-relative">
                            <b>Ranged Attack</b>
                            <button type="button" class="position-absolute btn btn-sm btn-light text-danger" style="top:0;right:0;" onclick="remove_attack(this);"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Attack Name</label>
                                <input class="attack_name_input form-control" type="text" name="attacks[`+index+`][attack_name]">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group pb-2">
                                <label>Attack Range</label>
                                <input class="attack_range_input form-control" type="text" name="attacks[`+index+`][attack_rng]">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group pb-2">
                                <label>Attack ROF</label>
                                <input class="attack_rof_input form-control" type="text" name="attacks[`+index+`][attack_rof]">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group pb-2">
                                <label>Attack AOE</label>
                                <input class="attack_aoe_input form-control" type="text" name="attacks[`+index+`][attack_aoe]">
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="form-group pb-2">
                                <label>Attack POW</label>
                                <input class="attack_pow_input form-control" type="text" name="attacks[`+index+`][attack_pow]">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Attack Description</label>
                                <textarea class="attack_desc_input form-control" rows="4" name="attacks[`+index+`][attack_desc]"></textarea>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }

            //properties
            function prefill_properties(){
                var container = $('.property_lists');
                container.html('');
                $.each(unit_properties, function(x,y){
                    var property = create_property();
                    var obj = $(property);
                    obj.find('.property_name_input').val(y.property_name);
                    obj.find('.property_desc_input').val(y.property_desc);
                    
                    container.append(obj);
                });
            }

            function add_property(){
                var obj = create_property();
                var container = $('.property_lists');
                container.append(obj);
            }

            function remove_property(btn){
                var row_property = $(btn).closest('.property');
                row_property.remove();
            }

            function create_property(){
                var index = 0;
                var attacks = $(".property_lists .property");
                $.each(attacks, function(x,y){
                    var att = $(y).data('property');
                    index = att+1;
                });
                var html = `
                    <div class="row property my-2 border-secondary p-4 border" data-property="`+index+`">
                        <div class="col-12 position-relative">
                            <button type="button" class="position-absolute btn btn-sm btn-light text-danger" style="top:0;right:0;" onclick="remove_property(this);"><i class="fa-solid fa-times"></i></button>
                            <div class="form-group pb-2">
                                <label>Property Name</label>
                                <input class="property_name_input form-control" type="text" name="properties[`+index+`][property_name]">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Property Description</label>
                                <textarea class="property_desc_input form-control" rows="4" name="properties[`+index+`][property_desc]"></textarea>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }
            
            //spells
            function prefill_spells(){
                var container = $('.spell_lists');
                container.html('');
                $.each(unit_spells, function(x,y){
                    var spell = create_spell();
                    var obj = $(spell);
                    obj.find('.spell_name_input').val(y.spell_name);
                    obj.find('.spell_cost_input').val(y.spell_cost);
                    obj.find('.spell_range_input').val(y.spell_range);
                    obj.find('.spell_aoe_input').val(y.spell_aoe);
                    obj.find('.spell_pow_input').val(y.spell_pow);
                    obj.find('.spell_upkeep_input').val(y.spell_upkeep);
                    obj.find('.spell_offensive_input').val(y.spell_offensive);
                    obj.find('.spell_desc_input').val(y.spell_desc);

                    container.append(obj);
                });
            }

            function add_spell(){
                var obj = create_spell();
                var container = $('.spell_lists');
                container.append(obj);
            }

            function remove_spell(btn){
                var row_spell = $(btn).closest('.spell');
                row_spell.remove();
            }

            function create_spell(){
                var index = 0;
                var spell = $(".spell_lists .spell");
                $.each(spell, function(x,y){
                    var att = $(y).data('spell');
                    index = att+1;
                });
                var html = `
                    <div class="row spell my-2 border-secondary p-4 border" data-spell="`+index+`">
                        <div class="col-12 position-relative">
                            <button type="button" class="position-absolute btn btn-sm btn-light text-danger" style="top:0;right:0;" onclick="remove_spell(this);"><i class="fa-solid fa-times"></i></button>
                            <div class="form-group pb-2">
                                <label>Spell Name</label>
                                <input class="spell_name_input form-control" type="text" name="spells[`+index+`][spell_name]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell Cost</label>
                                <input class="spell_cost_input form-control" type="text" name="spells[`+index+`][spell_cost]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell Range</label>
                                <input class="spell_range_input form-control" type="text" name="spells[`+index+`][spell_range]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell AOE</label>
                                <input class="spell_aoe_input form-control" type="text" name="spells[`+index+`][spell_aoe]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell POW</label>
                                <input class="spell_pow_input form-control" type="text" name="spells[`+index+`][spell_pow]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell Upkeep</label>
                                <input class="spell_upkeep_input form-control" type="text" name="spells[`+index+`][spell_upkeep]">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group pb-2">
                                <label>Spell Offensive</label>
                                <input class="spell_offensive_input form-control" type="text" name="spells[`+index+`][spell_offensive]">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Spell Description</label>
                                <textarea class="spell_desc_input form-control" rows="4" name="spells[`+index+`][spell_desc]"></textarea>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }
            
            //features
            function prefill_features(){
                var container = $('.feature_lists');
                container.html('');

                $.each(unit_features, function(x,y){
                    var feature = create_feature();
                    var obj = $(feature);
                    obj.find('.feature_name_input').val(y.feat_name);
                    obj.find('.feature_desc_input').val(y.feat_desc);

                    container.append(obj);
                });
            }

            function add_feature(){
                var obj = create_feature();
                var container = $('.feature_lists');
                container.append(obj);
            }

            function remove_feature(btn){
                var row_feature = $(btn).closest('.feature');
                row_feature.remove();
            }

            function create_feature(){
                var index = 0;
                var feature = $(".feature_lists .feature");
                $.each(feature, function(x,y){
                    var att = $(y).data('feature');
                    index = att+1;
                });
                var html = `
                    <div class="row feature my-2 border-secondary p-4 border" data-feature="`+index+`">
                        <div class="col-12 position-relative">
                            <button type="button" class="position-absolute btn btn-sm btn-light text-danger" style="top:0;right:0;" onclick="remove_feature(this);"><i class="fa-solid fa-times"></i></button>
                            <div class="form-group pb-2">
                                <label>Feature Name</label>
                                <input class="feature_name_input form-control" type="text" name="features[`+index+`][feat_name]">
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-group pb-2">
                                <label>Feature Description</label>
                                <textarea class="feature_desc_input form-control" rows="4" name="features[`+index+`][feat_desc]"></textarea>
                            </div>
                        </div>
                    </div>
                `;

                return html;
            }
        </script>
        <script>
            //display stuffs
            function fill_displayed_stats(){
                fill_basic_stats();
                fill_unit_stats();
                fill_unit_attacks();
                fill_unit_properties();
                fill_unit_spells();
                fill_unit_features();
            }

            function fill_basic_stats(){
                $.each(basic_stats, function(x,y){
                    if(x == "stat_name"){
                        $(".stat-name").html(y);
                    }
                    if(x == "stat_title"){
                        $(".stat-title").html(y);
                    }
                    if(x == "stat_size"){
                        $(".stat-size").html(y);
                    }

                    if(x == "stat_photo"){
                        $(".stat-photo img").attr("src", y);
                    }

                    if(x == "stat_lore"){
                        $(".stat-lore").html(y);
                    }

                    if(x == "unit_faction"){
                        $(".unit-faction").attr('class', 'card unit-faction');
                        $(".unit-faction").addClass(y);

                        var result = faction_lists.filter(function(app){
                            return app.value === y;
                        });

                        if(result.length > 0){
                            var obj = result[0];
                            $(".faction-logo").attr('src', obj.logo);
                        }
                    }
                });
            }

            function fill_unit_stats(){
                var stat_container = $(".main-stats");
                var spd = unit_stats.spd_stat;
                var str = unit_stats.str_stat;
                var mat = unit_stats.mat_stat;
                var rat = unit_stats.rat_stat;
                var def = unit_stats.def_stat;
                var arm = unit_stats.arm_stat;
                var cmd = unit_stats.cmd_stat;
                var focus = unit_stats.focus_stat;
                var vitality = unit_stats.vitality_stat;

                var init = parseInt(spd)+parseInt(str)-2+3;
                $(".stat-init .init h2").html(init);

                stat_container.find(".spd").html(spd);
                stat_container.find(".str").html(str);
                stat_container.find(".mat").html(mat);
                stat_container.find(".rat").html(rat);
                stat_container.find(".def").html(def);
                stat_container.find(".arm").html(arm);
                stat_container.find(".cmd").html(cmd);

                if(focus > 0){
                    $(".stat-focus").removeClass('d-none');
                    $(".stat-focus .focus h2").html(focus);
                }else{
                    $(".stat-focus").addClass('d-none');
                }

                var container = $(".vitality-bars");
                var bar = '';
                for(var i = 0; i <= vitality; i++){
                    if(i == vitality){
                        bar += `
                            <div class="col-auto text-danger me-1 mb-1" style="background-color:#c7c7c7;"><i class="fa-solid fa-heart"></i></div>
                        `;
                    }else{
                        bar += `
                            <div class="col-auto bg-warning me-1 mb-1">&nbsp;</div>
                        `;
                    }
                    
                }

                container.html(bar);
            }

            function fill_unit_attacks(){
                var container = $(".card .attacks");
                var row = '';

                $.each(unit_attacks, function(x,y){
                    if(y.attack_type == 'melee'){
                        html = get_attack_melee_html(y);
                    }else{
                        html = get_attack_ranged_html(y);
                    }
                    row += html;
                });

                container.html(row);
            }

            function get_attack_melee_html(stat){
                var html = `
                    <div class="row parchment attack">
                        <div class="col-3 d-flex align-items-center">
                            <div class="w-100 icon melee"></div>
                        </div>
                        <div class="col-9">
                            <table class="table text-center">
                                <thead>
                                    <tr>
                                        <th colspan="3" class="text-start">`+stat.attack_name+`</th>
                                    </tr>
                                    <tr class="text-white bg-black">
                                        <th>RNG</th>
                                        <th>POW</th>
                                        <th>P+S</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>`+stat.attack_rng+`</td>
                                        <td>`+stat.attack_pow+`</td>
                                        <td>`+stat.attack_damage+`</td>
                                    </tr>
                                    <tr>
                                        <td colspan="3" class="text-muted text-start small">
                                            `+stat.attack_desc+`
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return html;
            }

            function get_attack_ranged_html(stat){
                var html = `
                    <div class="row parchment attack">
                        <div class="col-3 d-flex align-items-center">
                            <div class="w-100 icon ranged"></div>
                        </div>
                        <div class="col-9">
                            <table class="table text-center">
                                <thead>
                                    <tr>
                                        <th colspan="3" class="text-start">`+stat.attack_name+`</th>
                                    </tr>
                                    <tr class="text-white bg-black">
                                        <th>RNG</th>
                                        <th>ROF</th>
                                        <th>AOE</th>
                                        <th>POW</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>`+stat.attack_rng+`</td>
                                        <td>`+stat.attack_rof+`</td>
                                        <td>`+stat.attack_aoe+`</td>
                                        <td>`+stat.attack_pow+`</td>
                                    </tr>
                                    <tr>
                                        <td colspan="4" class="text-muted text-start small">
                                            `+stat.attack_desc+`
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                return html;
            }

            function fill_unit_properties(){
                var container = $(".stat-property");
                var row = '';
                $.each(unit_properties, function(x,y){
                    row += `
                        <div>
                            <div class="property-name">`+y.property_name+`</div>
                            <div class="property-desc text-muted small">
                                `+y.property_desc+`
                            </div>
                        </div>
                    `;
                });

                container.html(row);
            }

            function fill_unit_spells(){
                var container = $(".stat-spells tbody");
                var row = '';
                $.each(unit_spells, function(x,y){
                    row += `
                        <tr>
                            <td class="text-start">
                                `+y.spell_name+`
                            </td>
                            <td>`+y.spell_cost+`</td>
                            <td>`+y.spell_range+`</td>
                            <td>`+y.spell_aoe+`</td>
                            <td>`+y.spell_pow+`</td>
                            <td>`+y.spell_upkeep+`</td>
                            <td>`+y.spell_offensive+`</td>
                        </tr>
                        <tr>
                            <td colspan="7" class="text-muted text-start">
                                `+y.spell_desc+`
                            </td>
                        </tr>
                    `
                });

                container.html(row);
            }

            function fill_unit_features(){
                var container = $(".stat-features");
                var row = '';
                $.each(unit_features, function(x,y){
                    row += `
                        <div class="feat my-2">
                            <div class="feat-name fw-bold">
                                `+y.feat_name+`
                            </div>
                            <div class="feat-description">
                                `+y.feat_desc+`
                            </div>
                        </div>
                    `
                });

                container.html(row);
            }
        </script>
        <script>
            //initiator
             $(document).ready(function(){
                prefill_modal();
                fill_displayed_stats();
            });

            var _json;
            function checkKeyExist(obj, key){
                var check = Object.keys(obj).filter(k => k.startsWith(key));
                return check.length > 0;
            }
            function reconcile_data(form){
                var form_data = new FormData(form);
                var object = {};
                form_data.forEach((value, key) => {
                    // Reflect.has in favor of: object.hasOwnProperty(key)
                    if(!Reflect.has(object, key)){
                        object[key] = value;
                        return;
                    }
                    if(!Array.isArray(object[key])){
                        object[key] = [object[key]];    
                    }
                    object[key].push(value);
                });
                var data = JSON.stringify(object);
                data = JSON.parse(data);
                _json = data;

                basic_stats.stat_name = data.stat_name;
                basic_stats.stat_title = data.stat_title;
                basic_stats.unit_faction = data.unit_faction;
                basic_stats.stat_size = data.stat_size;
                basic_stats.stat_lore = data.stat_lore;
                basic_stats.stat_photo = data.stat_photo;

                unit_stats.arm_stat = data.stat_arm;
                unit_stats.spd_stat = data.stat_spd;
                unit_stats.str_stat = data.stat_str;
                unit_stats.mat_stat = data.stat_mat;
                unit_stats.rat_stat = data.stat_rat;
                unit_stats.def_stat = data.stat_def;
                unit_stats.cmd_stat = data.stat_cmd;
                unit_stats.focus_stat = data.stat_focus;
                unit_stats.vitality_stat = data.stat_vitality;

                var getting = true;
                var i = 0;
                var new_attacks = [];
                var new_properties = [];
                var new_spells = [];
                var new_features = [];
                while(getting){
                    getting = false;

                    //attacks
                    var key = 'attacks['+i+']';
                    var keys = checkKeyExist(data, key);
                    if(keys){
                        getting = true;
                        var type = data[key+"[attack_type]"];
                        if(type == "melee"){
                            var attack = {
                                "attack_name":data[key+"[attack_name]"],
                                "attack_type":data[key+"[attack_type]"],
                                "attack_rng":data[key+"[attack_rng]"],
                                "attack_pow":data[key+"[attack_pow]"],
                                "attack_damage":data[key+"[attack_damage]"],
                                "attack_desc":data[key+"[attack_desc]"]
                            };
                            new_attacks.push(attack);
                        }else{
                            var attack = {
                                "attack_name":data[key+"[attack_name]"],
                                "attack_type":data[key+"[attack_type]"],
                                "attack_rng":data[key+"[attack_rng]"],
                                "attack_rof":data[key+"[attack_rof]"],
                                "attack_aoe":data[key+"[attack_aoe]"],
                                "attack_pow":data[key+"[attack_pow]"],
                                "attack_desc":data[key+"[attack_desc]"]
                            };
                            new_attacks.push(attack);
                        }
                    }

                    var key = 'properties['+i+']';
                    var keys = checkKeyExist(data, key);
                    if(keys){
                        getting = true;
                        var property = {
                            "property_name":data[key+"[property_name]"],
                            "property_desc":data[key+"[property_desc]"]
                        };
                        new_properties.push(property);
                    }

                    var key = 'spells['+i+']';
                    var keys = checkKeyExist(data, key);
                    if(keys){
                        getting = true;
                        var spell = {
                            "spell_name":data[key+"[spell_name]"],
                            "spell_cost":data[key+"[spell_cost]"],
                            "spell_aoe":data[key+"[spell_aoe]"],
                            "spell_range":data[key+"[spell_range]"],
                            "spell_pow":data[key+"[spell_pow]"],
                            "spell_upkeep":data[key+"[spell_upkeep]"],
                            "spell_offensive":data[key+"[spell_offensive]"],
                            "spell_desc":data[key+"[spell_desc]"]
                            
                        };
                        new_spells.push(spell);
                    }

                    var key = 'features['+i+']';
                    var keys = checkKeyExist(data, key);
                    if(keys){
                        getting = true;
                        var feat = {
                            "feat_name":data[key+"[feat_name]"],
                            "feat_desc":data[key+"[feat_desc]"]
                            
                        };
                        new_features.push(feat);
                    }

                    i++;
                }

                unit_attacks = new_attacks;
                unit_features = new_features;
                unit_properties = new_properties;
                unit_spells = new_spells;

                $('#modal_edit').modal('hide');
                fill_displayed_stats();
                prefill_modal();
            }

            function save_data(){
                var save_data = {
                    'basic_stats':basic_stats,
                    'unit_stats':unit_stats,
                    'unit_attacks':unit_attacks,
                    'unit_properties':unit_properties,
                    'unit_spells':unit_spells,
                    'unit_features':unit_features
                };

                var save_string = JSON.stringify(save_data);
                console.log(save_string);
                $("#save_output").val(save_string);
            }

            function load_data(){
                var data = $("#load_data").val();
                var parsed = JSON.parse(data);

                basic_stats = parsed.basic_stats;
                unit_stats = parsed.unit_stats;
                unit_attacks = parsed.unit_attacks;
                unit_properties = parsed.unit_properties;
                unit_spells = parsed.unit_spells;
                unit_features = parsed.unit_features;
                
                fill_displayed_stats();
                prefill_modal();

                $("#load_data").html('');

                $("#modal_load").modal('hide');
            }

            function delete_data(){
                basic_stats = {
                    "unit_faction":"",
                    "stat_name":"", 
                    "stat_title":"",
                    "stat_size":"",
                    "stat_photo":"",
                    "stat_lore": ""
                };

                unit_stats = {
                    "spd_stat":8,
                    "str_stat":8,
                    "mat_stat":8,
                    "rat_stat":8,
                    "def_stat":8,
                    "arm_stat":8,
                    "cmd_stat":8,
                    "vit_stat":8,
                    "focus_stat":0,
                    "vitality_stat":0
                };

                unit_attacks = [];
                unit_properties = [];
                unit_spells = [];
                unit_features = [];

                fill_displayed_stats();
                prefill_modal();
            }
        </script>
    </body>
</html>