<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Image Viewer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.1/openseadragon.min.js"></script>
    <style>
        /* Custom styles to complement Bootstrap's dark theme */
        body, html {
            overflow: hidden;
            user-select: none;
        }

        #sidebar {
            min-width: 70px;
            max-width: 600px;
            position: relative;
            overflow: hidden; /* Hide text when collapsed */
            background-color: #212529; /* Bootstrap dark color */
        }

        #drag-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 8px;
            height: 100%;
            cursor: col-resize;
            z-index: 10;
        }

        .list-group-item .item-details {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Custom active state with left border */
        .list-group-item.active {
            border-left: 4px solid #fff;
            background-color: #343a40; /* A slightly lighter dark for active state */
            border-color: #495057;
        }
        
        .list-group-item-action:hover {
            background-color: #343a40;
        }

        #viewer-container {
            position: relative;
            background-color: #000;
        }

         #viewer-loading{
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            color: #6c757d;
            position:absolute;
            top:0;
            height:100%;
            width:100%;
         }
        
        #viewer-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 1.5em;
            color: #6c757d;
        }

    </style>
    <style>
        .lds-ripple,
        .lds-ripple div {
            box-sizing: border-box;
        }
        .lds-ripple {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .lds-ripple div {
            position: absolute;
            border: 4px solid currentColor;
            opacity: 1;
            border-radius: 50%;
            animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite;
        }
        .lds-ripple div:nth-child(2) {
            animation-delay: -0.5s;
        }
        @keyframes lds-ripple {
            0% {
                top: 36px;
                left: 36px;
                width: 8px;
                height: 8px;
                opacity: 0;
            }
            4.9% {
                top: 36px;
                left: 36px;
                width: 8px;
                height: 8px;
                opacity: 0;
            }
            5% {
                top: 36px;
                left: 36px;
                width: 8px;
                height: 8px;
                opacity: 1;
            }
            100% {
                top: 0;
                left: 0;
                width: 80px;
                height: 80px;
                opacity: 0;
            }
        }
    </style>
</head>
<body class="text-light">

<div id="app-container" class="d-flex vh-100">
    <!-- Sidebar -->
    <div id="sidebar" class="d-flex flex-column">
        <div id="controls" class="p-2 border-top border-bottom border-secondary">
            <label for="folder-input" class="btn btn-dark w-100 text-start d-flex">
                <i class="bi bi-folder me-2"></i>
                <span>Select Folder</span>
            </label>
            <input type="file" id="folder-input" class="d-none" webkitdirectory directory multiple>
            <button id="refresh-btn" class="btn btn-dark w-100 mt-2 text-start d-flex">
                <i class="bi bi-arrow-clockwise me-2"></i>
                <span>Unload</span>
            </button>
        </div>
        <ul id="imageList" class="list-group list-group-flush flex-grow-1 overflow-auto"></ul>
        <div id="drag-handle"></div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="d-flex flex-column flex-grow-1 bg-body-tertiary">
        <div id="viewer-header" class="p-2 bg-dark text-secondary text-center border-bottom border-secondary">
            No file selected
        </div>
        <div id="viewer-container" class="flex-grow-1">
            <div id="viewer-placeholder">
                Select a folder to begin
            </div>
            <div id="viewer-loading" class="d-none">
                <div id="loading" class="lds-ripple"><div></div><div></div></div>
            </div>
        </div>
        <div id="snapshot-bar" class="p-2 bg-dark text-center border-top border-secondary">
            <button id="snapshot-btn" class="btn btn-success">
                <i class="bi bi-camera me-1"></i> Take Snapshot
            </button>
        </div>
    </div>
</div>

<script>
    function showLoading(){
        $("#viewer-loading").removeClass('d-none');
    }

    function closeLoading(){
        $("#viewer-loading").addClass('d-none');
    }

    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const dragHandle = document.getElementById('drag-handle');
        const folderInput = document.getElementById('folder-input');
        const imageListElement = document.getElementById('imageList');
        const viewerContainer = document.getElementById('viewer-container');
        const viewerHeader = document.getElementById('viewer-header');
        const refreshBtn = document.getElementById('refresh-btn');
        const snapshotBtn = document.getElementById('snapshot-btn');

        let viewer = null;
        let fileObjects = []; 
        let currentObjectURL = null;

        // --- Sidebar Dragging Logic ---
        const minWidth = 70;
        const maxWidth = 600;

        dragHandle.addEventListener('mousedown', function (e) {
            e.preventDefault();
            function handleMouseMove(e) {
                const clampedWidth = Math.max(minWidth, Math.min(e.clientX, maxWidth));
                sidebar.style.width = clampedWidth + 'px';
            }
            function handleMouseUp() {
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        });

        function getViewer() {
            if (!viewer) {
                const placeholder = document.getElementById('viewer-placeholder');
                if (placeholder) placeholder.remove();
                
                let viewerDiv = document.createElement('div');
                viewerDiv.id = 'openseadragon-viewer';
                viewerDiv.style.width = '100%';
                viewerDiv.style.height = '100%';
                viewerContainer.appendChild(viewerDiv);
                
                viewer = OpenSeadragon({
                    id: 'openseadragon-viewer',
                    prefixUrl: 'https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.1/images/',
                    showNavigator: true,
                    navigatorPosition: 'BOTTOM_RIGHT',
                    maxZoomPixelRatio: 15,
                    imageLoaderLimit: 10,
                });

                viewer.addHandler('tile-drawn', function hideSpinnerOnFirstDraw() {
                    viewer.removeHandler('tile-drawn', hideSpinnerOnFirstDraw);
                });
            }
            return viewer;
        }

        function openImage(file, listItem) {
            showLoading();
            const osdViewer = getViewer();
            if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
            currentObjectURL = URL.createObjectURL(file);
            osdViewer.open({ type: 'image', url: currentObjectURL });
            viewerHeader.textContent = file.name; 
            document.querySelectorAll('#imageList .list-group-item').forEach(item => item.classList.remove('active'));
            listItem.classList.add('active');
            closeLoading();
        }
        
        function resetViewer() {
            if (viewer) viewer.close();
            imageListElement.innerHTML = '';
            fileObjects = [];
            viewerHeader.textContent = 'No file selected';
            folderInput.value = ''; 
            if (!document.getElementById('viewer-placeholder')) {
                const placeholder = document.createElement('div');
                placeholder.id = 'viewer-placeholder';
                placeholder.textContent = 'Select a folder to begin';
                viewerContainer.innerHTML = ''; // Clear OSD div
                viewerContainer.appendChild(placeholder);
                viewer = null;
            }
        }

        function takeSnapshot() {
            if (!viewer || !viewer.drawer) {
                alert("Please open an image first.");
                return;
            }
            const canvas = viewer.drawer.canvas;
            const dataURL = canvas.toDataURL("image/jpeg");
            const link = document.createElement("a");
            link.href = dataURL;
            link.download = `snapshot_${viewerHeader.textContent.replace(/\.[^/.]+$/, "")}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        folderInput.addEventListener('change', function (event) {
            showLoading();
            const files = event.target.files;

            const imageFiles = Array.from(files).filter(file => {
                return /\.(jpeg|png|gif|webp|svg|bmp|tiff)$/i.test(file.name);
            }).sort((a, b) => a.name.localeCompare(b.name)); 

            if (imageFiles.length === 0) {
                 imageListElement.innerHTML = `<li class="list-group-item bg-dark text-secondary">No images found.</li>`;
                 viewerHeader.textContent = 'No images found';
                 return;
            }

            imageFiles.forEach((file) => {
                fileObjects.push(file); 
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item list-group-item-action bg-dark text-light border-secondary';
                listItem.style.cursor = 'pointer';
                
                listItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                           <i class="bi bi-image" style="font-size: 1.5rem;"></i>
                        </div>
                        <div class="item-details flex-grow-1">
                            <strong class="item-title d-block text-truncate">${file.name}</strong>
                            <small class="item-subtitle text-secondary">${formatBytes(file.size)}</small>
                        </div>
                    </div>
                `;
                listItem.title = file.name;
                
                listItem.addEventListener('click', () => openImage(file, listItem));
                imageListElement.appendChild(listItem);
            });
            
            if (fileObjects.length > 0) {
                openImage(fileObjects[0], imageListElement.firstChild);
            }
            closeLoading();
        });

        refreshBtn.addEventListener('click', resetViewer);
        snapshotBtn.addEventListener('click', takeSnapshot);
    });
</script>

</body>
</html>
